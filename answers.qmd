---
title: "Relationships"
subtitle: "Exercise 7 --- PMAP 8551/4551, SEMESTER YEAR"
author: "YOUR NAME HERE"
date: "DATE GOES HERE"
date-format: "long"
format:
  html:
    toc: true
    knitr:
      opts_chunk: 
        dev: "ragg_png"
        dpi: 300
  typst:
    toc: true
    include-before-body: 
      text: |
        #show link: set text(fill: rgb("e16462"))

        // Keep track of previous heading levels
        #let last-heading-level = state("last-heading-level", 0)

        // Add page breaks before all level 1 headings
        // Add page breaks before level 2 headings that don't come after level 1
        #show heading: it => {
          context {
            let prev-level = last-heading-level.get()

            if it.level == 1 {
              pagebreak(weak: true)
              last-heading-level.update(1)
            } else if it.level == 2 {
              if prev-level != 1 {
                pagebreak(weak: true)
              }
              last-heading-level.update(2)
            } else {
              last-heading-level.update(it.level)
            }
          }
          it
        }
  pdf:
    toc: true
  docx:
    toc: true
---

# Task 1: Session check-in

::: {.callout-tip title="Answer"}
Hopefully you wrote some interesting and muddy things!
:::


# Task 2: WNBA stats

```{r}
#| label: setup
#| warning: false
#| message: false

library(tidyverse)
library(patchwork)
library(broom)
library(marginaleffects)
```

## Data description

This data comes from <https://www.basketball-reference.com/wnba/players/> and contains information on WNBA basketball players from the 2019 season. The data was originally collected for the book [*Bayes Rules! An Introduction to Applied Bayesian Modeling*](https://www.bayesrulesbook.com/) and was included in the [{bayesrules} package](https://bayes-rules.github.io/bayesrules/docs/index.html) as `basketball`.

There are 33 columns, and [they're documented here](https://bayes-rules.github.io/bayesrules/docs/reference/basketball.html)---make sure you consult that page!

For this exercise, you'll only really worry about these columns (but you're free to use any others for your extension if you want!):

| Variable        | Definition                                                        |
|:----------------|:------------------------------------------------------------------|
| `total_minutes` | Total number of minutes played throughout the season              |
| `games_played`  | Number of games played throughout the season                      |
| `starter`       | True if player started in more than half of the games they played |
| `avg_points`    | Average number of points scored per game                          |
| `age`           | Player age                                                        |

The code below loads the data. **You don't need to modify anything in this chunk of code---you only need to run it.**

```{r}
#| label: load-data
#| warning: false
#| message: false

wnba <- read_csv("data/wnba.csv")
```


## Combining plots with {patchwork}

Make three plots from the `wnba` data:

1. A histogram showing the distribution of player age (you'll probably want to use a binwidth of 1 so you can show bars with whole years)
2. A scatterplot showing the relationship between average points (`x`) and total minutes (`y`), colored by `starter`
3. A scatterplot showing the relationship between games played (`x`) and total minutes (`y`), colored by `starter`

**Combine these three plots with {patchwork}**. Look at [the documentation](https://patchwork.data-imaginist.com/articles/guides/assembly.html) to see fancy ways of combining them, like having two rows inside a column.

::: {.callout-tip title="Answer"}

These instructions were pretty generic, and you could be as fancy as you want. Here's one verison:

```{r}
#| label: patchwork-plots
#| fig-width: 7
#| fig-height: 4
#| message: false

p_age <- ggplot(wnba, aes(x = age)) +
  geom_histogram(
    binwidth = 1,
    fill = "#FA4C01",
    color = "white",
    boundary = 0
  ) +
  labs(x = "Age", y = "Count", title = "WNBA player age, 2019") +
  theme_light()

p_points <- ggplot(wnba, aes(x = avg_points, y = total_minutes)) +
  geom_smooth(method = "lm", color = "#FA4C01") +
  geom_point(aes(color = starter)) +
  theme_light() +
  labs(
    x = "Average points per game",
    y = "Total season minutes",
    color = "Starter",
    title = "Points per game and total minutes"
  )

p_games <- ggplot(wnba, aes(x = games_played, y = total_minutes)) +
  geom_smooth(method = "lm", color = "#FA4C01") +
  geom_point(aes(color = starter)) +
  theme_light() +
  labs(
    x = "Games played in the season",
    y = "Total season minutes",
    color = "Starter",
    title = "Games played and total minutes"
  )

p_age | (p_points / p_games)
```

:::


## Visualizing regression

### Recreate model

Use the `wnba` data to create a model that predicts the total number of minutes a WNBA player played based on their average points, whether they're a starter, and the number of games they played in 2019 (hint: the formula will look like this: `total_minutes ~ avg_points + starter + games_played`)

Use `lm()` and `tidy()` to recreate this table:

```r
model_minutes_results <- tidy(model_minutes, conf.int = TRUE)
model_minutes_results

#> # A tibble: 4 × 7
#>   term         estimate std.error statistic  p.value conf.low conf.high
#>   <chr>           <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
#> 1 (Intercept)    -140.     16.8       -8.37 5.06e-14   -174.     -107. 
#> 2 avg_points       30.8     2.93      10.5  1.82e-19     25.0      36.6
#> 3 starterTRUE     172.     19.9        8.66 9.70e-15    133.      212. 
#> 4 games_played     14.9     0.832     17.9  3.46e-38     13.2      16.5
```

::: {.callout-tip title="Answer"}

```{r}
#| label: recreate-me-1

model_minutes <- lm(
  total_minutes ~ avg_points + starter + games_played, 
  data = wnba
)

model_minutes_results <- tidy(model_minutes, conf.int = TRUE)
model_minutes_results
```

:::

### Recreate coefficient plot

Run the code chunk below to see a plot.

```{r fig.path="images/"}
#| label: recreate-me-2
#| echo: false
#| message: false
#| warning: false
#| ref.label: recreation-plot-2
```

This is a coefficient plot and it shows the partial slopes (or effect) of each of the explanatory variables in the model. Holding all else equal, a one-point increase in a player's average points is associated with ≈30 more total minutes played in a season; being a starter is associated with ≈170 more total minutes played in a season; and so on.

Use `geom_pointrange()` in the chunk below to re-create the coefficient plot.

- *Do not* try to plot the results of `lm()` directly. You need to feed the model you create to `tidy()` to create a plottable data frame:

  ```r
  your_model <- lm(...)

  data_to_plot <- tidy(your_model, conf.int = TRUE)
  ```

- You'll need to calculate confidence intervale to plot the `xmin` and `xmax` values. Do this by setting `conf.int = TRUE` inside `tidy()`.

- You'll need to remove the intercept. Use something like `filter(term != "(Intercept)")`

- The plot uses `theme_light()`

- Use `\n` to add line breaks in the label (like `labs(title = "Really long\ntext")`)

::: {.callout-tip title="Answer"}

```{r}
#| label: recreation-plot-2
#| message: false
#| warning: false

model_minutes_results <- model_minutes_results |>
  filter(term != "(Intercept)")

ggplot(model_minutes_results, aes(x = estimate, y = term)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  labs(
    x = "Estimate",
    y = "Variable",
    title = "Predictors of total minutes",
    subtitle = "A one-unit increase in each variable is associated with\n{Estimate} additional minutes of game time in a season "
  ) +
  theme_light()
```

:::


### Recreate predicted values

Run the code chunk below to see a plot.

```{r fig.path="images/"}
#| label: recreate-me-3
#| echo: false
#| ref.label: recreation-plot-3
#| message: false
```

This shows what happens to the predicted number of total minutes as a typical player increases the number of games they've played—unsurprisingly, it goes up! This is actually the same stuff we saw in the coefficient plot—the slope for `games_played` here is ≈15, so total minutes increases by 15 for each game played; the coefficient for `starter` is 172, so the line is 172 minutes higher for starters.

Use `predictions()` (from the {marginaleffects} package) and `geom_line()` and `geom_ribbon()` in the chunk below to re-create the predictions plot.

- Refer to the ["Predicted values and marginal effects in 2025"](https://datavizf25.classes.andrewheiss.com/example/07-example.html#predicted-values-and-marginal-effects-in-2025) section of the example page!

- You'll need to create a dataset of predicted values first. You'll do something like this:

  ```r
  my_predictions <- predictions(
    NAME_OF_YOUR_MODEL,
    newdata = datagrid(
      games_played = seq(1, 34, by = 1),
      starter = c(FALSE, TRUE)
    )
  )
  ```

- To get the color and fill correct on both the line and the ribbon, you'll need to use the fill aesthetic in `geom_ribbon()` and the color aesthetic in `geom_line()`.

- The plot uses `theme_light()`

::: {.callout-tip title="Answer"}

```{r}
#| label: recreation-plot-3

my_predictions <- predictions(
  model_minutes,
  newdata = datagrid(
    games_played = seq(1, 34, by = 1),
    starter = c(FALSE, TRUE)
  )
)

ggplot(my_predictions, aes(x = games_played, y = estimate)) +
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high, fill = starter),
    alpha = 0.2
  ) +
  geom_line(aes(color = starter)) +
  labs(
    x = "Games played",
    y = "Predicted total minutes",
    color = "Starter",
    fill = "Starter"
  ) +
  theme_light()
```

:::


# Task 3: Extension

Try one of these things for your extension:

- **Different model**: Interact `starter` with `games_played` in the model (do this by multiplying the variables instead of adding them, like `starter * games played`) and make a predicted values plot. Interpret the plot. What's different about this version of the model?
- **Correlogram**: Create a correlogram heatmap, either with `geom_tile()` or with points sized by the correlation. Use any variables you want from `wnba`.
- **Anything else**: The theme for this week is relationships, so do something neat to show how different variables are related in the `wnba` data.

**This is your chance to play around and explore.**

::: {.callout-tip title="Answer"}

Hopefully you did something neat! Here's something I did with the different model. The slopes are different for starters vs. non-starters. Starting players accumulate total playtime faster than non-starting players.

```{r}
#| label: extension-1
#| message: false
#| warning: false
#| fig-width: 5
#| fig-height: 3

model_different <- lm(
  total_minutes ~ avg_points + (starter * games_played), 
  data = wnba
)

different_predictions <- predictions(
  model_different,
  newdata = datagrid(
    games_played = seq(1, 34, by = 1),
    starter = c(FALSE, TRUE)
  )
)

ggplot(different_predictions, aes(x = games_played, y = estimate)) +
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high, fill = starter),
    alpha = 0.2
  ) +
  geom_line(aes(color = starter)) +
  scale_color_manual(values = c("#3D427A", "#FA4C01")) +
  scale_fill_manual(values = c("#3D427A", "#FA4C01")) +
  labs(
    x = "Games played",
    y = "Predicted total minutes",
    color = "Starter",
    fill = "Starter",
    title = "Starting players accumulate game time faster"
  ) +
  theme_light()
```

:::

::: {.callout-tip title="Answer"}

And here's something I did with a correlogram:

```{r}
#| label: extension-2
#| message: false
#| warning: false
#| fig-width: 5
#| fig-height: 3

# Create a correlation matrix
things_to_correlate <- wnba |>
  select(total_minutes, games_played, avg_field_goals, age) |>
  cor()

# Get rid of the lower triangle
things_to_correlate[lower.tri(things_to_correlate)] <- NA

things_to_correlate_long <- things_to_correlate |>
  # Convert from a matrix to a data frame
  as.data.frame() |>
  # Matrixes have column names that don't get converted to columns when using
  # as.data.frame(), so this adds those names as a column
  rownames_to_column("measure2") |>
  # Make this long. Take all the columns except measure2 and put their names in
  # a column named measure1 and their values in a column named cor
  pivot_longer(cols = -measure2, names_to = "measure1", values_to = "cor") |>
  # Make a new column with the rounded version of the correlation value
  mutate(nice_cor = round(cor, 2)) |>
  # Remove rows where the two measures are the same (like the correlation
  # between humidity and humidity)
  filter(measure2 != measure1) |>
  # Get rid of the empty triangle
  filter(!is.na(cor)) |>
  # Put these categories in order
  mutate(measure1 = fct_inorder(measure1), measure2 = fct_inorder(measure2))

ggplot(things_to_correlate_long, aes(x = measure2, y = measure1, fill = cor)) +
  geom_tile() +
  geom_text(aes(label = nice_cor)) +
  scale_fill_gradient2(
    low = "#3D427A",
    mid = "white",
    high = "#FA4C01",
    limits = c(-1, 1)
  ) +
  labs(x = NULL, y = NULL, fill = "Correlation") +
  coord_equal() +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5)
  )
```

:::
